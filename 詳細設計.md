# 詳細設計.md

バージョン: v0.3  (更新日: YYYY-MM-DD)  ※v0.2→v0.3 主変更: ExitNotice 統一 / ResultDispatcherThread 明確化 / 再起動&ヘルス閾値 / ドロップアルゴリズム記述 / Export仕様補強 / timestamp & monotonic 方針 / InferenceError 追加 / pickle リスク注意。
参照: `要件.md`, `基本設計.md`, `CODING_STYLE.md`

> 本書はクラス/関数/データ構造/制御フロー/例外仕様/テスト観点を精緻化し、GitHub Copilot に直接投入できる粒度へ分解する。実装フェーズでは本記述との差異は必ず更新。

---
## 1. 実装ディレクトリ構成 (案)
```
app/
  main.py                      # エントリーポイント (CLI → Orchestrator 起動)
  scripts/
    config/                    # 設定読み込みと検証
      loader.py                # ConfigLoader 実装
      schema.py                # バリデーション定義 (必要時)
    core/                      # コアランタイム (プロセス/IPC/集約)
      orchestrator.py          # Orchestrator (ResultDispatcherThread 内部保有)
      worker.py                # CaptureInferenceWorker
      aggregator.py            # Aggregator / RingBuffer
      recorder.py              # Recorder
      models.py                # データモデル定義 (抽象仕様)
      errors.py                # 例外種別
      utils_time.py            # 時刻/計測ユーティリティ
      messages.py              # IPC メッセージ型 (抽象インタフェース記述のみ)
      logging_setup.py         # 集中ロギング初期化
      metrics.py               # MetricsThread (統計/ストール検知)
    gui/
      adapter.py               # GUIAdapter (内部状態→表示用 DTO)
      app_gui.py (後続)
  tools/
    convert_model.py           # モデル変換ツール
  logs/ (生成)                 # 実行時ログ
  results/                     # エクスポート/録画
  models/                      # IRファイル配置
  resources/
    ApplicationConfig.xml
```

---
## 2. データモデル / メッセージ抽象仕様
実装コードは本書に記載しない。以下はフィールド定義レベルの抽象仕様。

### 2.1 推論結果 (`ResultRecord`)
- camera_id: str
- timestamp_utc: datetime (UTC, ISO8601 出力想定)
- gesture_label: str
- confidence: float (0.0–1.0)
- latency_ms: float? (前処理+推論区間。計測不能時 None)

### 2.2 設定サブ構造例
- CameraConfig: id, url
- ModelConfig: ir_xml, ir_bin, metadata
- InferenceConfig: target_fps, device
- RetryConfig: connect_max_attempts, connect_backoff_sec (指数/線形選択は loader で確定)
- BufferConfig: results_max_entries
- RecordingConfig: enabled, output_dir
- ExportConfig: default_format
- GUIConfig: theme
- LoggingConfig: dir, level, rotate_max_mb, rotate_backups
Config ルートは上記を集約し基本イミュータブル(再代入禁止)。

### 2.3 IPC メッセージ種別 (messages.py)
| 名称 | 方向 | 主要フィールド | 説明 |
|------|------|---------------|------|
| ControlMessage | 親→子 | type(START/STOP/RELOAD/PING), payload(dict) | 制御指示 |
| StatusUpdate | 子→親 | camera_id, status(INIT/RUNNING/RETRYING/DOWN/EXITING), attempts, last_error? | 状態通知 |
| StatsMessage | 子→親 | camera_id, fps, avg_latency_ms?, drop_rate? | 周期統計 |
| ExitNotice | 子→親 | camera_id, code(0=正常), reason | 終了通知 (ControlMessage に EXITING は存在しない) |

シリアライズ: Python 標準 pickle (初期) → パフォーマンス要件で msgpack 検討 (オープン事項 D-05)。

---
## 3. 主要クラス詳細仕様
### 3.1 ConfigLoader (loader.py)
| 項目 | 内容 |
|------|------|
| 目的 | ApplicationConfig.xml を読み込み `Config` オブジェクトを返却 |
| 入力 | Path (XMLファイル) |
| 出力 | Config (成功) |
| 例外 | ValidationError (不足/不正), FileNotFoundError |
| ログ | INFO: 読込開始/完了, ERROR: 失敗詳細 |
| 処理 | XML→dict→型変換→値検証(必須/範囲)→Config生成 |

擬似コード:
```python
def load(path: Path) -> Config:
    xml = _read_xml(path)
    raw = _xml_to_dict(xml)
    _validate(raw)
    return _to_config(raw)
```

### 3.2 Orchestrator (orchestrator.py)
| 項目 | 内容 |
|------|------|
| 目的 | 子プロセス生成/監視/停止制御 |
| 状態 | config, workers(dict[camera_id, ProcessHandle]), aggregator, stop_event, result_queue, log_queue, control_conns, metrics_thread, result_dispatcher_thread |
| 主要メソッド | start(), stop(), spawn_worker(camera_id), broadcast(msg)->bool, _monitor_loop(), _run_dispatcher() |
| 例外 | モデル/設定致命エラー伝播で SystemExit |
| ログ | INFO: 起動/停止, WARNING: 再起動試行, ERROR: 子異常終了 |
| 制御 | start(): ログ初期化→result_queue 消費スレッド開始→各カメラ spawn→監視スレッド起動→(GUI後) |
| 終了 | stop(): broadcast(STOP)→子JOIN→未終了terminate→result_queue SENTINEL→dispatcher join→listener停止→metrics停止 |
| 再起動管理 | restart_history(各camera, 300s窓) をリング保持し閾値超過で status=DOWN 固定 |
| ヘルス管理 | ping 送信 / 連続 timeout カウンタ保持 (threshold=3) で DOWN 判定 |

シーケンス(起動):
```
main -> ConfigLoader -> Orchestrator.start
  -> for each camera spawn_worker
  -> start GUI loop (非同期)
```

### 3.3 CaptureInferenceWorker (worker.py)
| 項目 | 内容 |
|------|------|
| 目的 | RTSP キャプチャ + 前処理 + OpenVINO 推論 + 結果送信 |
| ループ | while running: capture -> preprocess -> infer -> put_result(result_queue, record) -> 周期的に StatsMessage 送信 |
| 例外 | 初期接続失敗: 再試行; モデルロード失敗: 検知→親へ致命通知 |
| 最適化 | 最新優先: 標準=容量(例:1024)+古い1件破棄→再put (maxsize=1 案は将来最適化検討) |
| メトリクス | 推論時間計測→latency_ms 設定 |
| ログ | QueueHandler 経由 event_code 付与 |

ワーカ主要フロー (抽象):
1. ログキュー初期化 / 初期状態通知 (StatusUpdate INIT)
2. モデルロード (失敗時 致命ログ → 非0終了)
3. ループ:
  - 制御Pipe確認 (STOP 指示で break)
  - フレーム取得 (失敗: 再試行ポリシ適用; 上限超過で StatusUpdate DOWN)
  - 前処理 → 推論 → latency 測定
  - 結果キュー投入 (統一アルゴ: put_nowait→Full なら最古1件 get_nowait 破棄→1回のみ再 put。再失敗は WARNING)
  - 1秒周期で StatsMessage 送信 (fps / 平均レイテンシ / drop_rate)
4. 終了通知 (ExitNotice)

前処理簡略案: リサイズ→色空間変換→正規化。

### 3.4 Aggregator (aggregator.py)
| 目的 | 結果集約・リングバッファ保持・統計計算・エクスポート |
| データ | buffers: dict[camera_id, deque(ResultRecord, maxlen=capacity)] |
| API | push(record|stats|exit), query(camera_id, since), export(fmt, range, dest), snapshot_stats() |
| 統計 | FPS(直近1s), 平均遅延, 最終更新, drop_rate 融合 |
| 例外 | export 時 I/OError 伝播 |

### 3.5 Recorder (recorder.py)
| 目的 | 指定カメラ映像とメタ(開始/終了時刻, モデルver) を MP4+JSON 保存 |
| 戦略 | Frame tap: Worker から複製 or Orchestrator 経由ストリーム |
| API | start(camera_id), stop(camera_id) |
| 失敗 | 書込失敗->ERRORログ, 継続不可なら停止通知 |

### 3.6 GUIAdapter (adapter.py)
### 3.7 Logging Setup (logging_setup.py)
| 項目 | 内容 |
|------|------|
| 目的 | 集中ログ (JSON Lines) を構築しマルチプロセス衝突を防止 |
| 初期化 | 親: create log_queue, start QueueListener(thread, handlers=[RotatingFile, Console]) |
| 子 | setup_queue_logging(log_queue) -> root handlers クリア + QueueHandler のみ追加 |
| フォーマット | JSONFormatter (ts ISO8601 UTC, level, event, camera, msg, pid, process_name, extra metrics) |
| 終了 | sentinel(None) を log_queue.put で listener ループ終了 |

### 3.8 Metrics Thread (metrics.py)
周期 (既定 1s) で Aggregator.snapshot_stats() を取得し以下を実施:
1. カメラ毎の最終更新差分を計算し閾値超過で CAMERA_STALL ログ (WARNING)
2. fps/latency/drop_rate を DEBUG (PERF_LATENCY 等) で出力 (必要に応じサンプリング)
3. 高頻度ログ抑制のため遅延/ドロップ閾値 (可設定) を越えた場合のみ追加イベントコード生成

### 3.9 Shutdown Sequence 詳細 (抽象)
1. 停止要求発生 (ユーザ操作 / 例外 / システムイベント)
2. STOP 制御メッセージ一斉送信 (broadcast) 成功可否で Pipe 健全性評価
3. 監視ループで各 ExitNotice を収集 (タイムアウト監視)
4. タイムアウト超過プロセスは terminate (失敗時 強制終了ログ)
5. 結果キューへ SENTINEL → dispatcher thread 停止
6. MetricsThread join
7. ログキュー sentinel → QueueListener 終了 / ハンドラ flush
8. シャットダウン完了ログ (SHUTDOWN_COMPLETE)
| 目的 | Aggregator 内部状態→GUIレンダリング用 DTO へ変換 |
| API | build_dashboard_state() -> DashboardState |
| 含む | per-camera: latest frame (サムネイル), label, confidence, fps, status |

---
## 4. 例外クラス (errors.py)
```python
class ConfigValidationError(Exception):
  """設定値が不正。"""
class StreamConnectionError(Exception):
  """RTSP接続に失敗。再試行可。"""
class ModelLoadError(Exception):
  """モデルロード致命的失敗。"""
class InferenceError(Exception):
  """単フレーム推論失敗 (継続可能)"""
class IPCChannelError(Exception):
  """制御Pipe/Queue の異常 (切断/破損)。"""
```
Fatal 判定: ConfigValidationError, ModelLoadError → 起動中断。

---
## 5. ログポリシー具体化
| コンテキスト | ログレベル | メッセージ例 | event_code |
|--------------|------------|--------------|------------|
| 起動完了 | INFO | Startup complete cameras=3 | STARTUP_COMPLETE |
| 再接続 | WARNING | Reconnecting camera=cam01 attempt=2 | CAPTURE_RETRY |
| 推論失敗(単発) | ERROR | Inference failed camera=cam02 err=... | INFER_FAIL |
| モデルロード失敗 | CRITICAL | Model load failed path=... | MODEL_LOAD_ERROR |
| 性能遅延 | DEBUG | Latency high camera=cam01 ms=180 | PERF_LATENCY |
| キュー飽和 | WARNING | Result queue full camera=cam01 drop=1 | RESULT_DROP |
| ストール | WARNING | Camera stalled camera=cam02 last_update=... | CAMERA_STALL |
| 子終了 | INFO | Worker exit camera=cam01 code=0 | WORKER_EXIT |
| 強制終了 | ERROR | Worker terminate camera=cam03 | WORKER_FORCE_TERMINATE |

---
## 6. シーケンス (例: 正常起動→解析→録画→停止)
```
User -> main.py -> ConfigLoader.load
 -> Orchestrator.start
   -> spawn_worker(cam01..N)
   -> each worker: capture loop -> infer -> queue -> Aggregator.push
 -> GUI: poll Aggregator/build_dashboard_state -> render
User: start recording cam01 -> Recorder.start -> file open
User: stop recording cam01 -> Recorder.stop -> write metadata
User: exit -> Orchestrator.stop -> workers stop -> flush -> crash? none -> exit
```

---
## 7. フロー(異常系) 例: カメラ接続断
```
Worker capture fail -> retry (backoff)
  -> attempts exceed -> send status=DOWN to Orchestrator
  -> Orchestrator logs WARNING/ERROR
  -> (将来) GUI indicates reconnect
```

---
## 8. パフォーマンス設計詳細
| 項目 | 方針 | 測定方法 |
|------|------|----------|
| 推論レイテンシ | 前処理+推論時間計測 | time.perf_counter 差分 (内部は monotonic) |
| FPS | Aggregator が一定期間内の件数集計 | 1s ウィンドウ |
| メモリ | 各プロセスモデル1個 | OSツール/psutil (後) |
| ドロップ率 | キャプチャ受信数 vs 推論送信数 | カウンタ差分 |
| ストール検知閾値 | last_result_age > 3/target_fps +1s | metrics thread |

---
## 9. テスト詳細観点 (補足)
| コンポーネント | Unit | Integration | Performance |
|----------------|------|-------------|-------------|
| ConfigLoader | XML→Config 正常/欠落値 | - | - |
| Orchestrator | spawn停止制御 | 複数ワーカー起動 | - |
| Worker | 前処理/ラベル整形/結果投入ドロップ制御 | RTSP疑似ソース | 推論レイテンシ |
| Aggregator | push/query/export/統計融合 | End-to-end カメラ2台 | - |
| Recorder | start/stop メタ生成 | 擬似フレーム供給 | 書込速度(任意) |
| Logging | QueueHandler -> Listener JSON構造 | 子2台並列ログ | - |
| Shutdown | sentinel 処理/全子正常終了 | - | - |

---
## 10. 実装優先順位 (MVPスライス)
1. ConfigLoader + messages + logging_setup (Queue) + 単一カメラ Worker + Aggregator + dispatcher thread (CLI統計)
2. 複数カメラ + StatsMessage 統計表示 + ドロップ制御
3. GUIAdapter + 仮GUI(簡易表示)
4. Recorder 基本機能
5. エクスポート機能
6. 健全性 (ストール検知) & graceful shutdown 強化

---
## 11. Copilot プロンプト用最小入力テンプレ
```
【Goal】基本/詳細設計をコード化 (MVP → 拡張)。
【Focus】ConfigLoader -> messages -> logging_setup -> Orchestrator -> Worker -> Aggregator MVP
【Constraints】要件/NFR遵守, pathlib, env禁止, Google Docstring, 90% tests, 集中ログ, IPC メッセージ型使用。
【Interfaces】load(), start()/stop()/broadcast(), push(), query(), export(), snapshot_stats()
【Error Policy】設定/モデル致命=即停止, 接続断=再試行, 単発推論エラー=継続, IPC断=再起動/停止。
【Deliverables】コード+pytest+使用例+改善提案
```

---
## 12. オープン事項 (詳細設計レベル)
| ID | 内容 | 対応 |
|----|------|------|
| D-01 | RTSP 取得ライブラリ最適案 (opencv vs gstreamer) | PoC 比較 |
| D-02 | GUI イベントループ統合方法 | 実装時検証 |
| D-03 | Recorder パイプライン方式 (raw frame or encoded queue) | 選定 |
| D-04 | メタデータ書式拡張 (モデルハッシュ) | 後続検討 |
| D-05 | メッセージシリアライズ最適化 (pickle→msgpack) | 性能計測後 |
| D-06 | OpenTelemetry Exporter/OTLP | 要件追加時 |

---
## 13. 変更管理
- 本書更新は PR (label: detailed-design)。

---
(以上)
