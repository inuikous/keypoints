# 詳細設計.md

バージョン: v0.1  (作成日: YYYY-MM-DD 要更新)  
参照: `要件.md`, `基本設計.md`, `CODING_STYLE.md`

> 本書はクラス/関数/データ構造/制御フロー/例外仕様/テスト観点を精緻化し、GitHub Copilot に直接投入できる粒度へ分解する。実装フェーズでは本記述との差異は必ず更新。

---
## 1. 実装ディレクトリ構成 (案)
```
app/
  main.py                  # エントリーポイント (引数解析→Orchestrator起動)
  scripts/
    config/                # 設定読み込みと検証
      loader.py            # ConfigLoader 実装
      schema.py            # (任意) バリデーション定義
    core/
      orchestrator.py      # Orchestrator
      worker.py            # CaptureInferenceWorker
      aggregator.py        # Aggregator / RingBuffer
      recorder.py          # Recorder 実装
      models.py            # ResultRecord / dataclasses
      errors.py            # Custom 例外定義
      utils_time.py        # 時刻/計測ユーティリティ
    gui/
      adapter.py           # GUIAdapter (GUI層が使う中間モデル変換)
      app_gui.py (後続)    # GUI実装 (フレームワーク選定後)
  tools/
    convert_model.py       # モデル変換 (要件 FR-70/71)
  logs/ (生成)             # 実行時ログ出力
  results/                 # エクスポート/録画(録画は results/recordings/)
  models/                  # IRファイル
  resources/
    ApplicationConfig.xml
```

---
## 2. データクラス / 型定義
```python
# models.py
from __future__ import annotations
from dataclasses import dataclass
from datetime import datetime
from typing import Optional, List

@dataclass(slots=True)
class ResultRecord:
    camera_id: str
    timestamp_utc: datetime
    gesture_label: str
    confidence: float
    latency_ms: Optional[float] = None  # 計測可能なら設定

@dataclass(slots=True)
class CameraConfig:
    id: str
    url: str

@dataclass(slots=True)
class ModelConfig:
    ir_xml: str
    ir_bin: str
    metadata: str

@dataclass(slots=True)
class InferenceConfig:
    target_fps: int
    device: str  # AUTO/CPU/GPU

# ...他 (RetryConfig, BufferConfig, RecordingConfig, ExportConfig, GUIConfig, LoggingConfig)
```

`Config` ルートオブジェクトは上記サブ構造を保持し、イミュータブル(再代入禁止)を基本指針。

---
## 3. 主要クラス詳細仕様
### 3.1 ConfigLoader (loader.py)
| 項目 | 内容 |
|------|------|
| 目的 | ApplicationConfig.xml を読み込み `Config` オブジェクトを返却 |
| 入力 | Path (XMLファイル) |
| 出力 | Config (成功) |
| 例外 | ValidationError (不足/不正), FileNotFoundError |
| ログ | INFO: 読込開始/完了, ERROR: 失敗詳細 |
| 処理 | XML→dict→型変換→値検証(必須/範囲)→Config生成 |

擬似コード:
```python
def load(path: Path) -> Config:
    xml = _read_xml(path)
    raw = _xml_to_dict(xml)
    _validate(raw)
    return _to_config(raw)
```

### 3.2 Orchestrator (orchestrator.py)
| 項目 | 内容 |
|------|------|
| 目的 | 子プロセス生成/監視/停止制御 |
| 状態 | config, workers(dict[camera_id, ProcessHandle]), aggregator, stop_event |
| 主要メソッド | start(), stop(), spawn_worker(camera_id) |
| 例外 | モデル/設定致命エラー伝播で SystemExit |
| ログ | INFO: 起動/停止, WARNING: 再起動試行, ERROR: 子異常終了 |
| 制御 | start(): cameras loop→spawn_worker→GUI開始(後) |
| 終了 | stop(): STOP メッセージ→join(timeout)→未終了は terminate |

シーケンス(起動):
```
main -> ConfigLoader -> Orchestrator.start
  -> for each camera spawn_worker
  -> start GUI loop (非同期)
```

### 3.3 CaptureInferenceWorker (worker.py)
| 項目 | 内容 |
|------|------|
| 目的 | RTSP キャプチャ + 前処理 + OpenVINO 推論 + 結果送信 |
| ループ | while not stop_event: capture frame -> preprocess -> infer -> queue.put(ResultRecord) |
| 例外 | 初期接続失敗: 再試行; モデルロード失敗: 検知→親へ致命通知 |
| 最適化 | queue 最新優先 (maxsize=1 or clear/overwrite) |
| メトリクス | 推論時間計測→latency_ms 設定 |

前処理簡略案: リサイズ→色空間変換→正規化。

### 3.4 Aggregator (aggregator.py)
| 目的 | 結果集約・リングバッファ保持・統計計算・エクスポート |
| データ | buffers: dict[camera_id, deque(ResultRecord, maxlen=capacity)] |
| API | push(record), query(camera_id, since), export(fmt, range, dest) |
| 統計 | FPS = 件数/時間, 平均遅延, 最終更新時刻 |
| 例外 | export 時 I/OError 伝播 |

### 3.5 Recorder (recorder.py)
| 目的 | 指定カメラ映像とメタ(開始/終了時刻, モデルver) を MP4+JSON 保存 |
| 戦略 | Frame tap: Worker から複製 or Orchestrator 経由ストリーム |
| API | start(camera_id), stop(camera_id) |
| 失敗 | 書込失敗->ERRORログ, 継続不可なら停止通知 |

### 3.6 GUIAdapter (adapter.py)
| 目的 | Aggregator 内部状態→GUIレンダリング用 DTO へ変換 |
| API | build_dashboard_state() -> DashboardState |
| 含む | per-camera: latest frame (サムネイル), label, confidence, fps, status |

---
## 4. 例外クラス (errors.py)
```python
class ConfigValidationError(Exception):
    """設定値が不正。"""
class StreamConnectionError(Exception):
    """RTSP接続に失敗。再試行可。"""
class ModelLoadError(Exception):
    """モデルロード致命的失敗。"""
```
Fatal 判定: ConfigValidationError, ModelLoadError → 起動中断。

---
## 5. ログポリシー具体化
| コンテキスト | ログレベル | メッセージ例 | event_code |
|--------------|------------|--------------|------------|
| 起動完了 | INFO | Startup complete cameras=3 | STARTUP_COMPLETE |
| 再接続 | WARNING | Reconnecting camera=cam01 attempt=2 | CAPTURE_RETRY |
| 推論失敗(単発) | ERROR | Inference failed camera=cam02 err=... | INFER_FAIL |
| モデルロード失敗 | CRITICAL | Model load failed path=... | MODEL_LOAD_ERROR |
| 性能遅延 | DEBUG | Latency high camera=cam01 ms=180 | PERF_LATENCY |

---
## 6. シーケンス (例: 正常起動→解析→録画→停止)
```
User -> main.py -> ConfigLoader.load
 -> Orchestrator.start
   -> spawn_worker(cam01..N)
   -> each worker: capture loop -> infer -> queue -> Aggregator.push
 -> GUI: poll Aggregator/build_dashboard_state -> render
User: start recording cam01 -> Recorder.start -> file open
User: stop recording cam01 -> Recorder.stop -> write metadata
User: exit -> Orchestrator.stop -> workers stop -> flush -> crash? none -> exit
```

---
## 7. フロー(異常系) 例: カメラ接続断
```
Worker capture fail -> retry (backoff)
  -> attempts exceed -> send status=DOWN to Orchestrator
  -> Orchestrator logs WARNING/ERROR
  -> (将来) GUI indicates reconnect
```

---
## 8. パフォーマンス設計詳細
| 項目 | 方針 | 測定方法 |
|------|------|----------|
| 推論レイテンシ | 前処理+推論時間計測 | time.perf_counter 差分 |
| FPS | Aggregator が一定期間内の件数集計 | 1s ウィンドウ |
| メモリ | 各プロセスモデル1個 | OSツール/psutil (後) |
| ドロップ率 | キャプチャ受信数 vs 推論送信数 | カウンタ差分 |

---
## 9. テスト詳細観点 (補足)
| コンポーネント | Unit | Integration | Performance |
|----------------|------|-------------|-------------|
| ConfigLoader | XML→Config 正常/欠落値 | - | - |
| Orchestrator | spawn停止制御 | 複数ワーカー起動 | - |
| Worker | 前処理/ラベル整形 | RTSP疑似ソース | 推論レイテンシ |
| Aggregator | push/query/export | End-to-end カメラ2台 | - |
| Recorder | start/stop メタ生成 | 擬似フレーム供給 | 書込速度(任意) |

---
## 10. 実装優先順位 (MVPスライス)
1. ConfigLoader + モデルスタブ + 単一カメラ Worker + Aggregator (コンソール出力)
2. 複数カメラ並列 & FPS/Latency 計測
3. GUIAdapter + 仮GUI(簡易表示)
4. Recorder 基本機能
5. エクスポート機能

---
## 11. Copilot プロンプト用最小入力テンプレ
```
【Goal】基本設計/詳細設計を実装に落とす。
【Focus】ConfigLoader -> Orchestrator -> Worker -> Aggregator MVP
【Constraints】要件.md/NFR遵守, pathlib, env禁止, Google Docstring, 90% tests
【Interfaces】load(), start(), push(), query(), export()
【Error Policy】設定/モデル致命=即停止, 接続断=再試行, 単発推論エラー=継続
【Deliverables】コード+pytest+使用例+改善提案
```

---
## 12. オープン事項 (詳細設計レベル)
| ID | 内容 | 対応 |
|----|------|------|
| D-01 | RTSP 取得ライブラリ最適案 (opencv vs gstreamer) | PoC 比較 |
| D-02 | GUI イベントループ統合方法 | 実装時検証 |
| D-03 | Recorder パイプライン方式 (raw frame or encoded queue) | 選定 |
| D-04 | メタデータ書式拡張 (モデルハッシュ) | 後続検討 |

---
## 13. 変更管理
- 本書更新は PR (label: detailed-design)。

---
(以上)
