---
タイトル: <プロジェクト正式名称>
バージョン: 0.1-draft
作成日: <YYYY-MM-DD>
作成者: <氏名/役割>
最終更新: <auto>
ステータス: draft
---
# システム要件定義書 (テンプレート)
本書は基本設計/詳細設計/テスト計画/運用設計/プロンプト生成を一貫化するための“単一ソース”です。記入は簡潔かつ検証可能な形で行い、曖昧語を避けてください。

> 記入規則:
> - TBD は避ける。未確定は "<仮: ...>" と明示し "Open Questions" に紐付け。
> - 数値は単位付き (ms, MB, req/s, %)。
> - 優先度: Must / Should / Could / Won't (MoSCoW)。
> - 可観測/テスト可能な形で書く。

## 1. 概要 / ゴール
- 背景: 製造/教育/インタラクティブデモ現場でマウス/キーボード非接触操作や状態把握の需要が高まっている中、複数カメラからの手ジェスチャー検出をローカル環境のみで高速かつ拡張容易に行いたい。
- 解決したい課題: 単一/複数カメラ環境でのリアルタイム手ジェスチャー推論・可視化・記録・再生を一体化し、外部ネットワークに接続できない制約下で汎用PCの CPU / iGPU 資源を最大活用する。
- ゴール (1〜3行): オフライン環境で動作するマルチカメラ対応手ジェスチャー解析システムを構築し、GUI上に 100ms 未満の追加レイテンシで結果オーバーレイ表示、同時に録画・再生・設定変更が可能な状態を提供する。
- 非ゴール (Out of Scope): クラウド連携 / リモート管理ポータル / モバイル端末最適化 / 音声コマンド統合 / 外部ネットワーク越しのモデル自動更新。

## 2. ステークホルダー / 利用者ペルソナ
| 役割 | 主目的 | 成功指標 | 権限/制約 |
|------|--------|----------|-----------|
| Admin (システム管理) | カメラ/モデル/設定管理 | 稼働率>99%, 設定変更反映<5s | 設定書換/録画削除可 |
| Operator (現場利用) | ライブ解析/録画操作 | 検出遅延<0.3s, 操作成功率>99% | 設定閲覧/録画開始停止 |
| Analyst (オフライン解析) | 録画再生/ジェスチャー確認 | 再生シーク遅延<0.5s | ネット接続不可・読み取り専用 |
| External API Client | (当面非対象) | - | 非ゴール |

## 3. 用語集 / 定義 (Glossary)
| 用語 | 定義 | 参照 |
|------|------|------|
| フレーム | 単一カメラから取得した画像1枚 | - |
| ジェスチャー | モデルが分類する手の状態(例: open, fist, point, pinch 等) | モデルラベル |
| セッション | 起動〜終了の連続稼働期間 | ログID |
| 録画 | マルチカメラ映像と推論メタの同期保存単位 | 仕様7章 |
| メタデータ | 推論結果 (ラベル/信頼度/座標) | データモデル |

## 4. 全体アーキテクチャ (ラフ)
- コンポーネント列挙: カメラ入力モジュール / フレームキュー / 推論ワーカー(複数, multiprocessing) / OpenVINO最適化層 / 結果集約 / GUIレンダラ / 録画管理 / 設定管理 / ロギング&メトリクス。
- 外部システム・連携: なし（完全オフライン）。
- デプロイ想定: 単一ワークステーション (Windows / Linux) dev=開発者PC, prod=現場PC。
- 図 (mermaid概略): (後続追加)

```
Camera(N) --> Frame Queue --> Inference Workers (PyTorch→OpenVINO) --> Result Aggregator --> GUI
																			|                                       |
																		Recorder <------------------------------
```

## 5. 機能要件 (Functional Requirements)
| ID | 機能名 | 説明(ユーザ視点) | 条件/トリガ | 正常シナリオ結果 | 例外/エラー | 優先度 |
|----|--------|-----------------|-------------|------------------|------------|--------|
| FR-001 | マルチカメラ入力 | 複数/単一カメラを接続し映像取得を開始できる | 起動/設定変更 | すべての有効カメラがストリーム開始 | デバイス未検出/排他 | Must |
| FR-002 | リアルタイム推論 | 手ジェスチャーをリアルタイム分類 | 新規フレーム到着 | 推論結果(ラベル,信頼度,座標)生成 | モデルロード失敗 | Must |
| FR-003 | OpenVINO最適化 | PyTorch事前学習モデルをOpenVINO形式に最適化 | 初回起動/更新 | 最適化モデルキャッシュ生成 | 変換失敗 | Must |
| FR-004 | 並列推論処理 | カメラ数に応じプロセス並列実行 | カメラ追加 | スループット維持 | プロセス死活 | Must |
| FR-005 | GUI表示 | 映像+推論結果をオーバーレイ表示 | 推論結果更新 | 低遅延描画 | レンダラ例外 | Must |
| FR-006 | 設定管理 | GUI/設定ファイルでパラメータ変更 | 保存操作 | 次フレームから反映 | フォーマット不正 | Must |
| FR-007 | 録画保存 | 映像とメタを同期録画 | 録画開始指示 | ファイル & メタDB保存 | 容量不足 | Must |
| FR-008 | 録画再生 | 過去録画の再生/シーク | 再生操作 | 同期再生 & 推論オーバーレイ | ファイル欠損 | Should |
| FR-009 | ログ/メトリクス | 稼働/性能/エラーを記録 | イベント | ローカル出力 | 書込失敗 | Must |
| FR-010 | オフライン保証 | ネットワーク未接続でも動作 | 起動 | 通信試行なし | 接続試行検知 | Must |
| FR-011 | 設定ホットリロード | 設定変更再起動不要 | 設定更新 | 即座 or 次フレーム反映 | 競合 | Should |
| FR-012 | モデル切替 | 新モデル反映 | 指定操作 | 推論停止→再ロード→再開 | 不整合 | Could |
| FR-013 | ヘルス監視 | GUIで稼働状況表示 | 周期(1s) | FPS/遅延表示 | 取得失敗 | Should |

### 5.1 ユースケース (代表)
| UC | 主要アクター | 事前条件 | 基本フロー | 代替/例外 | 成功後状態 |
|----|--------------|----------|------------|----------|------------|
| UC-01 | Operator | カメラ接続済 | (1) アプリ起動 (2) 映像と推論表示 (3) 録画開始 (4) 録画停止 | カメラ1台のみ / 録画容量不足 | 録画ファイル生成 |
| UC-02 | Admin | モデルファイル配置 | (1) 設定画面でモデル選択 (2) 最適化 (3) 再ロード | 変換失敗→再試行 | 新モデル反映 |
| UC-03 | Analyst | 録画存在 | (1) 録画選択 (2) 再生 (3) シーク | ファイル欠損→エラー表示 | 再生完了 |

### 5.1 ユースケース (代表)
| UC | 主要アクター | 事前条件 | 基本フロー | 代替/例外 | 成功後状態 |
|----|--------------|----------|------------|----------|------------|
| UC-01 | | | (1) ... | | |

## 6. 非機能要件 (Quality Attributes)
| カテゴリ | 指標/数値 | 説明/測定方法 | 優先度 |
|----------|----------|---------------|--------|
| 性能(推論遅延) | 1カメラ: p95 追加レイテンシ <100ms | フレームタイムスタンプ差分 | Must |
| 性能(FPS) | 各カメラ 30fps 入力時 20fps 以上表示 | GUI計測 | Must |
| 並列スケール | カメラ4台時 CPU使用率≤85% | OSメトリクス | Should |
| 起動時間 | 初回最適化除き<5s | ログ計測 | Should |
| 可用性 | 稼働セッション中クラッシュ< 月1 | ログ集計 | Must |
| 信頼性 | 異常復帰 (ワーカ再起動) <10s | ウォッチャー計測 | Should |
| セキュリティ | 外部送信パケット 0 | ネット監視 | Must |
| 観測性 | FPS/遅延/キュー長/エラー率 ログ化 | 内部メトリクス | Must |
| テスト容易性 | ビジネスロジックカバレッジ ≥90% | CI | Must |
| 保守性 | 重要モジュール CC ≤10 | 静的解析 | Should |
| 拡張性 | 新カメラ追加設定<1分 | 手順測定 | Should |
| 資源効率 | iGPU有効化時 CPU使用率 -15% 以上 | 比較試験 | Could |

## 7. データモデル / 永続化
### 7.1 エンティティ一覧
| エンティティ | 概要 | 主キー | 主要属性 | 一意制約 | 備考 |
|--------------|------|--------|----------|----------|------|
| Camera | 物理/仮想カメラ設定 | camera_id | name,resolution,fps,enabled | name | 設定ファイル/GUI |
| FrameMeta | 推論対象フレームメタ | frame_id | camera_id,timestamp | (camera_id,timestamp) | 実体画像はバッファのみ |
| GestureEvent | 推論結果単位 | event_id | frame_id,label,confidence,bbox | (frame_id,label) | |
| Recording | 録画セッション | recording_id | start_ts,end_ts,path | start_ts | 動画+メタ同期 |
| Config | 設定キー値 | key | value | key | JSON/XML/INI検討 |

### 7.2 属性詳細 (例)
| Entity | 属性 | 型 | 必須 | デフォルト | バリデーション | 説明 |
|--------|------|----|------|-----------|----------------|------|
| GestureEvent | confidence | float | Yes | - | 0.0..1.0 | 確信度 |
| Camera | resolution | str | Yes | 1280x720 | 正規表現 | WxH |
| Recording | path | str | Yes | - | 既存dir | ファイル保存先 |

### 7.3 状態遷移 (録画)
| 状態 | 許可遷移先 | 条件 | 備考 |
|------|------------|------|------|
| idle | recording | ユーザ開始 | |
| recording | stopping | ユーザ停止 | フラッシュ中 |
| stopping | idle | 書込完了 | |

## 8. インターフェース (内部モジュール / GUI / CLI)
### 8.1 内部サービス境界 (想定)
| サービス | 提供API(関数/メソッド) | 主責務 | 依存 |
|----------|-----------------------|--------|------|
| CameraService | list(), start(id), stop(id) | カメラ制御 | OS, OpenCV |
| InferenceService | load_model(), infer(frame_batch) | 推論 | OpenVINO Runtime |
| RecordingService | start(), append(frame,meta), stop() | 録画 | FS |
| ConfigService | load(), save(partial) | 設定I/O | FS |
| MetricsService | record(metric,value) | メトリクス | ログ |

### 8.2 GUI 要件 (概要)
- 表示: マルチカメラグリッド / 各フレーム上にラベル+信頼度+BBox。
- 操作: 録画開始/停止, 設定変更(ドロップダウン/数値), モデル再読込。
- ステータス: FPS, 推論遅延, キュー長, CPU/GPU使用率。

### 8.3 CLI (Optional 初期)
| コマンド | 用途 | 主要オプション | 出力 |
|----------|------|-------------|------|
| keypoints run | GUI付き起動 | --config path | ログ |
| keypoints convert-model | モデル最適化 | --model path | 成功/失敗 |
| keypoints replay | 録画再生 | --recording id | 統計 |

## 9. バリデーション / 入出力制約
| 項目 | 制約 | エラーコード/例外 | メッセージ形式 |
|------|------|------------------|----------------|
| camera.name | 1..32 ASCII | ValidationError | 行為+対象+期待vs実際 |
| camera.resolution | 正規表現 ^[0-9]{3,4}x[0-9]{3,4}$ | ValidationError | 同上 |
| model.file | 存在/読み取り可 | FileNotFoundError | 同上 |
| recording.size | < 10GB/ファイル | ValueError | 同上 |

## 10. セキュリティ要件
- 認証方式: ローカル単一ユーザ想定 (初期: 認証無し, 将来Adminパスワード)。
- 認可: 役割分離は設定ファイルで抽象化 (Optional)。
- 外部通信: すべて禁止 (HTTP/S ソケット接続試行 0)。
- モデル/録画ファイル: 権限 600 (POSIX) 相当 / Windows ACL 制限。
- 監査ログ: 設定変更 / 録画開始停止 / モデル切替。
- 脆弱性管理: 依存ライブラリアップデート手動確認 (オフライン)。

## 11. ロギング / モニタリング / オブザーバビリティ
| 分類 | 項目 | 目的 | 収集方法 | 保持期間 |
|------|------|------|----------|----------|
| メトリクス | inference_latency_ms | SLO監視 | ローカル集計 | 14d |
| メトリクス | fps_per_camera | 性能監視 | 同上 | 14d |
| メトリクス | queue_depth | ボトルネック検知 | 同上 | 14d |
| ログ | audit_action | 追跡性 | JSON構造ログ | 30d |
| ログ | error | 障害調査 | JSON | 30d |
| トレース | (簡易ID) session_id | ひも付け | 付与のみ | 30d |

## 12. パフォーマンス / キャパシティ計画
| 項目 | 初期値 | 1年後予測 | スケール戦略 | 上限アラートしきい値 |
|------|--------|-----------|--------------|----------------------|
| 接続カメラ数 | 2 | 4 | CPU増設/iGPU活用 | 6 |
| 平均録画時間/日 | 2h | 4h | ストレージ追加 | 6h |
| 日次録画容量 | 20GB | 40GB | 外付SSD追加 | 50GB |

## 13. 可用性 / フェイルオーバー
- 冗長化対象: 進行中録画メタ (定期フラッシュ), 設定ファイルバックアップ。
- RPO: 1分 (録画メタ flush 間隔) / RTO: 再起動 < 2分。
- フェイルオーバー: 単一ノードのため再起動戦略のみ。
- バックアップ: 設定・録画メタ 1日1回ローカル複製。

## 14. エラーハンドリング / 失敗ドメイン
| ドメイン | 代表失敗 | 優雅な劣化 | リトライ方針 | フォールバック |
|----------|----------|-----------|--------------|--------------|
| カメラ入力 | デバイス切断 | GUI警告 & 自動再接続試行 | 500ms 間隔 5回 | 無効化扱い |
| 推論ワーカー | プロセス停止 | ウォッチャ再起動 | 1→2→4s backoff | 低頻度フレーム間引き |
| モデル最適化 | 変換失敗 | 直前安定版利用 | 即時再試行1回 | 失敗通知 |
| 録画 | ディスク不足 | 録画自動停止 | 不可 | 古い録画自動削除(設定可) |

## 15. デプロイ / リリース戦略
- ブランチモデル: main(安定) / develop / feature/*。
- CI/CD: GitHub Actions で lint/type/test/ビルド。成果物 ZIP 配布。
- デプロイ方式: 手動配置 (初期)。
- バージョニング: semver (破壊的変更を極力抑制 / 廃止ラッパ禁止)。
- ロールバック条件: 起動失敗 or 推論遅延>150ms が10分継続。

## 16. マイグレーション / 互換性ポリシー
- スキーマ変更: 追加列は後方互換 / 削除は1バージョン前リリースノート明記後即削除。
- 破壊的変更検知: mypy + 静的解析 + 参照検索 CI で差分検出。
- 廃止フロー: 互換ラッパ禁止 / rename 同PRで全置換。

## 17. 運用 / サポート
| 項目 | 内容 |
|------|------|
| 運用時間 | 09:00-18:00 平日 |
| 障害一次対応 | 管理者 (オンサイト) |
| 連絡系統 | 管理者 → 開発担当 |
| SLO/SLA | p95遅延<100ms / 可用性稼働時間比>99% |
| キャパシティレビュー周期 | 四半期 |

## 18. リスク / 対応策
| ID | リスク記述 | 影響(1-5) | 発生確率(1-5) | リスク値 | 対策 | プランB |
|----|-----------|-----------|---------------|----------|------|--------|
| R-01 | iGPU非対応環境 | 3 | 3 | 9 | CPU最適化パス | FPS低下許容モード |
| R-02 | 高負荷で遅延悪化 | 5 | 3 | 15 | バッチ/キュー調整 | カメラ自動間引き |
| R-03 | ディスク逼迫 | 4 | 4 | 16 | 上限監視+ローテ | 古い録画強制削除 |
| R-04 | モデル精度不足 | 4 | 2 | 8 | 評価指標ログ | モデル再学習計画 |

## 19. トレーサビリティ (要件→設計→テスト)
| 要件ID | 基本設計セクション | 実装モジュール(予定) | テストID | 備考 |
|--------|--------------------|---------------------|---------|------|
| FR-001 | 入力制御 | camera_service.py | TC-001 | |
| FR-002 | 推論 | inference_worker.py | TC-010 | |
| FR-005 | GUI | gui_renderer.py | TC-030 | |
| FR-007 | 録画 | recorder.py | TC-050 | |
| FR-010 | セキュリティ | startup_checks.py | TC-070 | 外部通信無検査 |

## 20. アクセプタンス基準 (Acceptance Criteria)
| ID | 条件 | 検証方法 | 判定基準 |
|----|------|----------|----------|
| AC-001 | 単一カメラ30fps入力時p95推論遅延<100ms | 計測スクリプト | 連続5分達成 |
| AC-002 | 2カメラ同時でGUI表示FPS>=20 | GUI計測 | 平均20fps以上 |
| AC-003 | 外部通信無し | ネット監視ツール | 送信パケット0 |
| AC-004 | 録画再生シーク<0.5s | 操作ログ比較 | 10回平均<0.5s |
| AC-005 | 設定変更反映<5s | タイムスタンプ計測 | 5s未満 |

## 21. プロンプト連携ノート
- Refine 想定曖昧例: 「いい感じに高速化」「録画とか適当に」「GPU最適化して」
- ブリーフ生成必須要素: Goal / 対象モジュール / 性能制約(FPS/遅延) / EdgeCases(カメラ切断, ディスク不足) / SuccessCriteria(測定指標と閾値)
- 自動生成テスト最小: 正常(1カメラ) + 複数(2カメラ) + カメラ切断 + ディスク不足シミュレーション
- 代替案比較指標優先: Speed / Robustness / Maintainability / Risk + (Optional) PerformanceGain

## 22. 監査 / コンプライアンス
| 項目 | 対応 | 証跡 | 周期 |
|------|------|------|------|
| ログ改ざん防止 | 追記専用ローテ | ファイルハッシュ | 月次 |
| アクセス制御 | ローカル物理制御 | - | - |

## 23. 開発制約 / 技術選定理由
| 項目 | 選定技術 | 代替案 | 選定理由(要約) | リスク |
|------|----------|--------|-----------------|--------|
| 言語 | Python 3.11 | C++ | 開発速度/豊富ライブラリ | パフォーマンス天井 |
| 推論 | PyTorch + OpenVINO | ONNXRuntime | 最適化+柔軟性 | 変換失敗可能性 |
| GUI | PyQt / PySide | OpenCV HighGUI | 拡張性/UI表現力 | サイズ増加 |
| 並列 | multiprocessing | threading | GIL回避 | IPCコスト |
| 設定 | YAML/JSON | INI | 可読性/階層表現 | スキーマ曖昧 |

## 24. オープン課題 (Open Questions)
| ID | 内容 | 必要回答日 | 担当 | 状態 | 回答/メモ |
|----|------|-----------|------|------|-----------|
| OQ-01 | 対応ジェスチャーラベル集合の確定 | <date> | PO | open | |
| OQ-02 | GUIフレームワーク最終選定(PyQt vs PySide) | <date> | Dev Lead | open | |
| OQ-03 | 設定ファイル形式(YAML vs JSON) | <date> | Dev | open | |
| OQ-04 | 最大カメラ台数ハード制約 | <date> | Infra | open | |
| OQ-05 | 保存動画コーデック(H.264 vs MJPEG) | <date> | Dev | open | |
| OQ-06 | モデル更新手順(手動差替え/ツール) | <date> | Admin | open | |
| OQ-07 | データ保持期間(録画/ログ) | <date> | Admin | open | |

## 25. 変更履歴
| 版 | 日付 | 変更概要 | 変更者 |
|----|------|----------|--------|
| 0.1 | <today> | テンプレ→初期要件反映 | <name> |

---
## 付録 A: サンプル記入 (抜粋例)
FR-001 画像アップロード: ユーザは PNG/JPEG を 10MB 以下でアップロード。p95 レイテンシ 500ms 未満。8MB 超で警告ログ。失敗時エラーコード 413/415/500。

## 付録 B: 曖昧表現禁止リスト
"いい感じ", "適当に", "ざっくり", "そこそこ", "まあまあ", "適度に", "柔軟に" → 数値/条件へ置換。

## 付録 C: 要件レビュー チェックリスト
- [ ] ゴールと非ゴールが分離
- [ ] すべての機能要件に例外/エラー定義
- [ ] 非機能に測定方法/閾値
- [ ] データ型/制約が明示
- [ ] リスク評価済 (高リスク>= 影響4 * 確率3 以上)
- [ ] Open Questions が独立管理
- [ ] 廃止ポリシー遵守記述
- [ ] テスト/トレーサビリティ行が空でない

---
(以上。記入後、このファイルを元に基本設計生成を依頼してください。)
