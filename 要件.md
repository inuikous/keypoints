# 要件.md

本書は画像解析AIシステム(仮称: Hand Gesture Multi-Cam Analyzer) の設計書作成前に**合意すべき機能要件/非機能要件/制約**を整理したもの。実装コードは本段階では作成しない。`要件_ベース.md` の列挙内容を正規化し、`CODING_STYLE.md` と `STANDARD_DEVELOPMENT_FLOW.md` の原則を反映する。

---
## 1. システム概要 (Summary)
複数のネットワークカメラ(最小1台)からリアルタイム映像を取得し、手のジェスチャーをAIで判定・可視化・保存するオフライン(閉域)向けデスクトップ/エッジ推論システム。推論モデルは PyTorch 事前学習済みモデルを OpenVINO IR 形式へ事前変換し CPU / iGPU で高速実行する。

---
## 2. 用語定義
| 用語 | 定義 |
|------|------|
| カメラ | RTSP(記述誤記: 元要件のRTPSをRTSPと解釈) 配信を行うネットワークカメラ |
| ストリーム | 単一カメラからの連続フレーム列 |
| ジェスチャー | 手指ポーズ/動作クラス(詳細クラス集合は後続で定義) |
| IRモデル | OpenVINO Intermediate Representation (XML+BIN) |
| 推論ワーカー | 1カメラ映像を受け取り推論を実行する並列プロセス(multiprocessing) |
| GUI | 推論結果(フレーム+推定ラベル/確信度) をリアルタイム表示する画面 |

---
## 3. 想定利用シナリオ (Use Cases)
| ID | シナリオ | 概要 | 成功条件 |
|----|----------|------|----------|
| UC-01 | 単一カメラリアルタイム解析 | 1台カメラ映像を解析表示 | 低遅延表示 & ラベル更新 |
| UC-02 | 複数カメラ同時解析 | N台(構成設定)を並列推論 | 各ストリーム途切れず更新 |
| UC-03 | 録画 | 指定カメラの映像を保存 | ファイルに時刻+メタ付与保存 |
| UC-04 | 録画再生解析 | 保存済み動画を読み込み再解析 | 映像と推論結果再生同期 |
| UC-05 | モデル事前準備 | PyTorch → OpenVINO IR 変換 | IRファイル生成 & 署名/バージョン記録 |
| UC-06 | 設定変更 | GUIまたは設定ファイルでパラメータ調整 | 次回起動/ホットリロード反映(仕様化要) |
| UC-07 | ログ/結果エクスポート | 推論結果(ラベル, 時刻) をCSV/JSON出力 | 指定期間/カメラで抽出成功 |
| UC-08 | 異常通知(任意) | ストリーム断/推論失敗ログ | GUI上ステータス/ログ出力 |

---
## 4. 機能要件 (Functional Requirements)
### 4.1 映像入力
- FR-01: RTSP URL 設定で 1..N 台カメラを登録できる。
- FR-02: 各カメラは独立プロセス/スレッド(基本: multiprocessing)でフレーム取得。
- FR-03: フレーム取得失敗(タイムアウト, 接続断) 時は指数バックオフで再接続(回数/間隔設定)。

### 4.2 推論
- FR-10: モデルは OpenVINO IR (XML+BIN) をロードし CPU もしくは利用可能 iGPU を自動判定。
- FR-11: 推論は最小指定FPS(例: 10fps) を目標。処理が遅延した場合は古いフレームをスキップ(最新優先, フレームドロップ戦略)。
- FR-12: ジェスチャークラス集合は設定ファイルで定義可能(後続でラベル数上限/仕様確定)。
- FR-13: 推論結果は (timestamp, camera_id, gesture_label, confidence) を構造体/辞書形式で発行。

### 4.3 並列処理
- FR-20: カメラごとに独立プロセス。GUI/集約処理はメインプロセス。
- FR-21: プロセス間通信は Queue/Pipe(推論結果, 制御メッセージ)。
- FR-22: Graceful shutdown: 終了要求でキャプチャ停止→キュー排出→プロセスjoin。

### 4.4 GUI 表示
- FR-30: 各カメラ映像サムネイル+最新ラベル+confidence をオーバーレイ表示。
- FR-31: FPS, 遅延(取得→表示時間), 接続状態(OK / Reconnecting / Error)を表示。
- FR-32: 任意カメラを拡大表示(詳細ビュー)可能。

### 4.5 録画/再生
- FR-40: ユーザ指定で録画開始/停止。保存形式(H.264 MP4 等)・保存先ディレクトリ設定。
- FR-41: 録画ファイルはメタデータ(JSON)を伴い開始/終了時刻, カメラID, 推論モデルバージョンを記録。
- FR-42: 再生時は実時間再現 または 高速/ステップ再生モードを選択。

### 4.6 結果保存/エクスポート
- FR-50: 推論結果をメモリリングバッファ保持(容量設定)し CSV / JSON で期間指定保存。
- FR-51: 一括エクスポート時のファイル名規約: `results/<camera_id>_<YYYYMMDD_HHMMSS>.<ext>`。

### 4.7 設定管理
- FR-60: 全設定は `resources/ApplicationConfig.xml` に集約。(環境変数使用禁止)
- FR-61: 設定(カメラURL, モデルパス, FPS目標, リトライ回数 等) を起動時ロード。
- FR-62: 将来ホットリロード対応余地を残す(初期スコープでは再起動反映でも可: 要決定)。

### 4.8 モデル準備ツール
- FR-70: `app/tools/convert_model.py` (予定) で PyTorch モデル → OpenVINO IR 変換。
- FR-71: 変換時にモデルメタデータ(JSON: 入力解像度, クラス数, 生成日時, バージョン) を出力し `models/` に保存。

### 4.9 ロギング/監視 (内部)
- FR-80: ログ種別: DEBUG(内部計測)/INFO(起動・状態)/WARNING(再試行)/ERROR(回復可能失敗)/CRITICAL(停止級)。
- FR-81: 推論遅延が閾値超過(例: 平均>目標FPS逆数×1.5) で WARNING。
- FR-82: ストリーム断検出時 (連続失敗N回) WARNING→再接続失敗継続で ERROR。

### 4.10 終了/回復
- FR-90: 異常終了時のスタック/最終ログを `app/logs/crash_<timestamp>.log` に出力。
- FR-91: Ctrl+C シグナル受信で安全に録画停止とプロセス終了。

---
## 5. 非機能要件 (Non-Functional Requirements)
| 区分 | 要件ID | 内容 |
|------|--------|------|
| 性能 | NFR-01 | 単一カメラ: 解析レイテンシ(キャプチャ→推論完了) 平均 < 120ms (CPU baseline) |
| 性能 | NFR-02 | 複数カメラ: N=4 で平均FPS >= 8 (各) を維持 (フレームスキップ可) |
| 資源 | NFR-03 | メモリ上限目安 < 2GB (4カメラ構成) |
| 可用 | NFR-04 | ストリーム断後 10秒以内に自動再接続試行開始 |
| 保守 | NFR-05 | 全公開関数に型/Docstring。循環的複雑度>10 の関数禁止(例外は Notes 記載) |
| テスト | NFR-06 | pytest カバレッジ 90% 以上 (モデル巨大部分は除外検討) |
| 移植 | NFR-07 | Windows 10 / Ubuntu LTS (x86_64) / iGPU(Intel) で動作 |
| セキュリティ | NFR-08 | 外部ネットワークアクセス禁止(モデル変換ツール除く) |
| ログ | NFR-09 | 機密値(パスワード等)をログ出力しない (本システムでは該当ほぼ無し) |
| 起動 | NFR-10 | 起動(設定ロード→GUI表示) < 5 秒 (4カメラ想定でキャプチャ開始を除く) |

---
## 6. システム構成(論理レイヤ)
```
[Config Loader] -> (settings) -> [Main Orchestrator] -> spawns -> [Capture+Inference Process x N]
                                                     -> results -> [Result Aggregator] -> GUI Renderer
                                                     -> record cmd -> [Recorder]
Tools: [Model Conversion (offline)] -> outputs -> models/*.xml, *.bin, metadata.json
```

---
## 7. コンポーネント概要
| コンポーネント | 役割 | 主I/F | 備考 |
|----------------|------|-------|------|
| Config Loader | ApplicationConfig.xml 読込/検証 | load() -> dict | スキーマ検討要 |
| Orchestrator | 起動順制御/プロセス生成/停止 | start(), stop() | シグナル対応 |
| Capture Worker | フレーム取得 + 前処理 | next_frame() | RTSP再接続ロジック |
| Inference Worker | モデルロード+推論 | infer(frame) -> gesture | OpenVINO Runtime |
| Result Aggregator | 結果集約, バッファ | push(result), export() | リングバッファ |
| GUI Renderer | 表示/操作イベント | render(state) | 遅延計測 |
| Recorder | 映像/メタ保存 | start(id), stop(id) | FFmpeg/Python依存検討 |
| Model Tool | PyTorch→IR変換 | CLI | tools/ に配置 |

---
## 8. 設定項目(初期案)
| 項目 | 例 | 説明 |
|------|----|------|
| cameras | list(URL) | RTSP URL 配列 |
| model.ir_xml | models/gesture.xml | IR XML パス |
| model.ir_bin | models/gesture.bin | IR BIN パス |
| model.metadata | models/gesture.meta.json | 変換メタ |
| inference.target_fps | 10 | 目標FPS |
| inference.device_preference | AUTO | CPU / GPU / AUTO |
| retry.connect.max_attempts | 5 | 再接続試行上限 |
| retry.connect.backoff_sec | 1.0 | 初期待機(指数) |
| buffer.results.max_entries | 10000 | リング保持上限 |
| recording.enabled | true | 録画機能有効化 |
| recording.output_dir | results/recordings | 保存先 |
| export.format.default | csv | 結果出力形式 |
| gui.theme | dark | UIテーマ(任意) |
| logging.dir | app/logs | ログ出力ディレクトリ(存在しなければ起動時生成) |

---
## 9. データモデル(論理)
```text
ResultRecord:
  camera_id: str
  timestamp_utc: datetime
  gesture_label: str
  confidence: float (0..1)
  latency_ms: float (オプション)

Metadata(model):
  model_name: str
  version: str
  created_at: datetime
  input_shape: [H, W, C]
  num_classes: int
  labels: [str]
```

---
## 10. エラーハンドリング / 例外ポリシー
| 事象 | 例外/対応 | ログレベル |
|------|-----------|------------|
| RTSP接続初回失敗 | 再試行(指数, 上限)→上限到達で停止通知 | WARNING→ERROR |
| フレームデコード失敗 | 該当フレームスキップ | WARNING |
| モデルロード失敗 | 起動中断 | CRITICAL |
| 推論実行失敗(一時) | フレームスキップ + 統計計上 | ERROR |
| 設定ファイル欠落/不正 | 起動中断(ValidationError) | CRITICAL |
| ディスク書込失敗(録画/エクスポート) | 操作中断+ユーザ通知 | ERROR |

例外は `raise CustomError(... ) from err` を原則。握りつぶし禁止。

---
## 11. ログ出力フォーマット(案)
`<timestamp> <level> <module> <camera_id?> <event_code> <message> key=value ...`
- event_code 例: `CAPTURE_RETRY`, `INFER_LATENCY_HIGH`, `STREAM_DOWN`, `EXPORT_DONE`
- 機密データは扱わない前提でマスク不要(追加される場合はポリシー更新)
- すべてのログファイルは `app/logs/` 配下にローテーション方針(後続設計)で保存。

---
## 12. テスト観点 (Initial Test Plan Seeds)
| カテゴリ | 観点例 |
|----------|--------|
| 正常 | 単一/複数カメラで推論結果が得られる |
| 境界 | カメラ=1 / 最大サポート台数 (要定義) |
| 性能 | N=4 で平均FPS計測 & 閾値検証 |
| 回復 | 接続断→再接続動作 |
| エラー | モデルファイル欠落 / 壊れたRTSP URL |
| 録画 | 録画開始/停止→ファイル生成とメタ一致 |
| 再生 | 保存動画の再解析結果一致 |
| エクスポート | 期間指定CSV/JSON件数一致 |
| 設定 | 不正値 (負FPS, 0クラス) バリデーション |

---
## 13. 開発プロセス適用 (DoD 連携)
- 要件確定後、`STANDARD_DEVELOPMENT_FLOW.md` 0/1 テンプレを埋めて設計プロンプトへ。
- DoD: 型/Docstring/テスト90%/Black/isort/Ruff/Dead code 無し。
- 破壊的変更: 旧API即削除(Deprecationポリシー適用)。

---
## 14. 非対応(Out of Scope 初期段階)
| 項目 | 理由 |
|------|------|
| クラウド/外部DB連携 | 閉域運用前提 |
| 自動モデルアップデート | オフラインポリシー |
| 認証/ユーザ管理 | ローカル端末専用前提 |
| 分散クラスタ推論 | 初期規模不要 |
| 音声/他センサ統合 | スコープ拡張は将来検討 |

---
## 15. オープン課題 (Open Issues)
| ID | 内容 | 影響 | 優先度 |
|----|------|------|--------|
| OI-01 | ジェスチャークラス定義集合 | 推論アウトプット仕様 | 高 |
| OI-02 | 最大カメラ台数性能検証値 | スケーラビリティ | 中 |
| OI-03 | GUI フレームワーク選定(PySide6 / Tk / others) | 実装工数/性能 | 中 |
| OI-04 | 録画エンコード方式(H.264ライブラリ) | 依存/ライセンス | 中 |
| OI-05 | ホットリロード対応範囲 | 運用性 | 低 |

---
## 16. リスク/軽減策
| リスク | 内容 | 軽減策 |
|--------|------|--------|
| 性能不足 | CPUのみでFPS未達 | OpenVINO最適化/FP16/バッチ最適化/フレームスキップ |
| 再接続不安定 | RTSP実装差異 | 互換性テスト/タイムアウト調整/ログ統計 |
| メモリ増加 | 複数プロセス起動 | 画像解像度制限/リングバッファ上限 |
| モデル変換失敗 | Ops未対応 | 変換スクリプト内で互換性チェッカー/警告表示 |
| GUI遅延 | 描画負荷 | サムネイル縮小/描画FPS制限/非同期描画 |

---
## 17. 承認 & 変更管理
- 本書は初版: v0.1 (作成日: YYYY-MM-DD 要更新)
- 変更要求は Issue に "要件変更" ラベルで登録→レビュー→反映。
- 互換性影響がある変更は Deprecation ポリシーに従い同PRで統合。

---
## 18. 参考
- `要件_ベース.md`
- `CODING_STYLE.md`
- `STANDARD_DEVELOPMENT_FLOW.md`
- OpenVINO Docs / PyTorch Docs (オフラインミラー推奨)

---
(以上)
