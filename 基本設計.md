# 基本設計.md

バージョン: v0.1  (作成日: YYYY-MM-DD 要更新)
対象システム: Hand Gesture Multi-Cam Analyzer
参照: `要件.md`, `CODING_STYLE.md`, `STANDARD_DEVELOPMENT_FLOW.md`

## 0. 目的 / 本文書の位置付け
`要件.md` で合意した機能/非機能要件を **実装可能な全体構造/責務分割/インタフェース方針** に落とし込み、後続の「詳細設計.md」でクラス/関数レベル仕様へ展開するための中間成果物。GitHub Copilot に読み込ませることで曖昧な補完を防ぐ。

---
## 1. スコープ
- 対象: 取得～推論～表示～録画～結果エクスポートの基盤。\
- 非対象: GUI 具体実装フレームワーク差異、最適化(低レベルSIMD)、運用ツール群。

---
## 2. アーキテクチャ概要
### 2.1 レイヤ構成
| レイヤ | 役割 | 主依存 | 備考 |
|--------|------|--------|------|
| Presentation (GUI) | 状態可視化/操作入力 | Aggregator API | PySide6 等想定 (最終選定 OI) |
| Orchestration | プロセス生成/停止/監視 | Config / IPC | 単一メインプロセス |
| Capture & Inference Workers | 映像取得と推論 | OpenVINO Runtime / RTSPライブラリ | multiprocessing 各プロセス |
| Aggregation | 結果集約/バッファ/エクスポート | 内部データ構造 | スレッドセーフ or マルチプロセスIPC |
| Recording | 映像書き出し | FFmpegラッパ | オプション 動的開始/停止 |
| Tools (Offline) | モデル変換 | PyTorch / OpenVINO | 実行時ネットワーク不要 |
| Configuration | 設定ロード/検証 | XML Parser | 変換→内部辞書/Typed構造 |

### 2.2 データフロー (リアルタイム)
```
RTSP Stream -> CaptureWorker -> (Queue FrameMeta) -> InferenceWorker -> (Queue ResultRecord)
  -> Orchestrator -> Aggregator(Buffer) -> GUI Renderer / Export / Recorder
```
遅延抑制: InferenceWorker はキュー最新フレームを優先 (古いもの破棄)。

### 2.3 プロセス/IPC モデル
- メイン: Orchestrator + Aggregator + GUI
- N 子プロセス: Capture+Inference を 1:1 or 1:2(分離案) **初期版は統合型 (シンプル)**
- IPC: `multiprocessing.Queue` (結果), `Pipe` or Queue (制御: start/stop/health ping)
- 終了: メイン→子へ STOP メッセージ→キューflush→join

---
## 3. コンポーネント責務定義
| 名称 | 主責務 | 入力 | 出力 | 例外方針 (概要) |
|------|--------|------|------|----------------|
| ConfigLoader | XML解析/検証/内部構造化 | XML Path | ConfigDict | 不正値→ValidationError 直ちに停止 |
| Orchestrator | プロセスライフサイクル/監視 | Config/Commands | プロセス状態イベント | 子異常→再起動 or 停止判定 |
| CaptureInferenceWorker | キャプチャ+前処理+推論 | RTSP, Model | ResultRecord | 接続断→再接続、モデル失敗→Fatal |
| Aggregator | 結果集約/リングバッファ/クエリ | ResultRecord | ExportData/ViewModel | バッファ溢れ→古い順破棄 WARN |
| Recorder | 映像保存+メタ出力 | フレーム | MP4+JSON | 書込失敗→ERROR 継続可否判定 |
| GUIAdapter | Aggregator 状態をGUI層向け整形 | AggregatedState | RenderState | 描画遅延計測/統計 |
| ModelConverter (tool) | PyTorch→IR 変換 | 原モデル | IR + metadata | 失敗→Exit code !=0 |

---
## 4. 主要インタフェース案 (シグネチャ草案)
(詳細設計で最終化。戻り値/例外は Google Docstring 想定)
```text
ConfigLoader.load(path: Path) -> Config
Orchestrator.start() -> None
Orchestrator.stop(timeout_s: float = 5.0) -> None
Orchestrator.spawn_worker(camera_id: str) -> None
Aggregator.push(result: ResultRecord) -> None
Aggregator.query(camera_id: str, since: datetime | None) -> List[ResultRecord]
Aggregator.export(fmt: str, range: TimeRange, dest: Path) -> Path
Recorder.start(camera_id: str) -> None
Recorder.stop(camera_id: str) -> Path
```

---
## 5. データ構造(概要レベル)
| 構造 | フィールド (要件.md 由来) | 備考 |
|------|----------------------------|------|
| ResultRecord | camera_id / timestamp_utc / gesture_label / confidence / latency_ms? | latency_ms は計測可能な場合のみ |
| Config | cameras / model.* / inference.* / retry.* / buffer.* / recording.* / export.* / gui.* / logging.* | XML→内部マッピング |
| RingBuffer | capacity:int / data:deque | Lock or process-safe wrapper |

---
## 6. エラーハンドリング戦略 (高位)
| レベル | 方針 |
|--------|------|
| 取得系 | 再試行(指数バックオフ)。上限超過→Orchestratorへ異常通知 |
| 推論 | 単フレーム失敗→スキップ継続 (ERROR ログ)。初期ロード失敗→起動中断 |
| 設定 | 起動前検証で Fail Fast |
| 書込 | 一時失敗→再試行1回; 継続失敗→ユーザ通知 & 録画停止 |

---
## 7. 性能/リソース方針
- FPS 目標未達時: フレームドロップ戦略 (queue maxlen=1~2)
- メモリ: 各ワーカーでモデル常駐、共有メモリ最小化 (再ロードコスト < メモリ節約検討余地)
- 計測: Aggregator が per-camera stats (avg latency, fps) を定期集計。

---
## 8. ログ/監視コンセプト
| 種別 | 例 event_code | 目的 |
|------|---------------|------|
| INFO | STARTUP_COMPLETE | 起動完了観測 |
| WARNING | CAPTURE_RETRY | 再接続回数監視 |
| ERROR | INFER_FAIL | 推論失敗率監視 |
| CRITICAL | MODEL_LOAD_ERROR | 即時停止判断 |
| METRIC(DEBUG) | PERF_LATENCY | 性能チューニング |

クラッシュログは `app/logs/crash_<timestamp>.log`。

---
## 9. 設定ファイル設計 (アウトライン)
XML 要素 → 内部キー (例)
```xml
<ApplicationConfig>
  <Cameras>
    <Camera id="cam01" url="rtsp://..."/>
  </Cameras>
  <Model xml="models/gesture.xml" bin="models/gesture.bin" metadata="models/gesture.meta.json" />
  <Inference target_fps="10" device="AUTO" />
  <Retry connect_max_attempts="5" connect_backoff_sec="1.0" />
  <Buffer results_max_entries="10000" />
  <Recording enabled="true" output_dir="results/recordings" />
  <Export default_format="csv" />
  <GUI theme="dark" />
  <Logging dir="app/logs" level="INFO" />
</ApplicationConfig>
```

---
## 10. テスト方針マッピング (概要)
| 要件ID | テストタイプ | 代表ケース |
|--------|--------------|------------|
| FR-01/02 | Integration | カメラ数=1/2 で起動成功 |
| FR-11 | Performance | 10fps 目標下で平均レイテンシ計測 |
| FR-50 | Unit+Integration | リングバッファ容量超過挙動 |
| FR-90 | Fault Injection | 強制例外→クラッシュログ生成 |
| NFR-02 | Load | 4カメラ並列 FPS 実測 |

---
## 11. 移植性/外部依存
- OpenVINO / PyTorch (変換時のみ)。\
- RTSPライブラリ候補: opencv(VideoCapture) 先行利用 → 性能課題時 GStreamer 再検討。

---
## 12. セキュリティ/閉域考慮
- 外部HTTP禁止: モデル/依存は事前配置のみ。\
- ログに資格情報なし (現時点で扱わない)。

---
## 13. オープン事項 (基本設計段階)
| ID | 内容 | 対応予定 |
|----|------|----------|
| OI-01 | ジェスチャークラス集合 | 詳細設計でラベルファイル仕様定義 |
| OI-02 | 最大カメラ台数 | 性能検証タスクで上限測定 |
| OI-03 | GUI フレームワーク | PoC 比較後決定 |

---
## 14. Copilot への提示用ミニ要約 (貼付テンプレ)
```
【Context】複数RTSP→OpenVINO推論→GUI表示システム。基本設計に従い詳細化/実装を行う。
【Modules】ConfigLoader / Orchestrator / Worker / Aggregator / Recorder / GUIAdapter
【Key Constraints】No env vars, path via pathlib, ≥90% tests, coverage of latency & reconnection.
【Interfaces(草案)】ConfigLoader.load, Orchestrator.start/stop, Aggregator.push/query/export ...
【Error Policy】取得再試行, 推論単フレーム失敗=継続, 設定/モデル致命=即停止
【Output Expectation】1) 詳細設計補完 2) 実装コード 3) テスト 4) 改善提案
```

---
## 15. 変更管理
- 本書更新は PR にて (label: basic-design)。

---
(以上)
