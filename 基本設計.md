# 基本設計.md

バージョン: v0.6  (更新日: 2025-08-20)  ※v0.5→v0.6 変更要約: マルチプロセス試験モード (use_process) 追加 / process worker エントリ `process_worker_entry.py` / Orchestrator にプロセス起動・停止 / Ping 監視を thread/proc 両対応化 (control_queue を multiprocessing.Queue に切替) / STOP ブロードキャスト & ExitNotice 収集 実装。
対象システム: Hand Gesture Multi-Cam Analyzer
参照: `要件.md`, `CODING_STYLE.md`, `STANDARD_DEVELOPMENT_FLOW.md`

## 0. 目的 / 本文書の位置付け
`要件.md` で合意した機能/非機能要件を **実装可能な全体構造/責務分割/インタフェース方針** に落とし込み、後続の「詳細設計.md」でクラス/関数レベル仕様へ展開するための中間成果物。GitHub Copilot に読み込ませることで曖昧な補完を防ぐ。

---
## 1. スコープ
- 対象: 取得～推論～表示～録画～結果エクスポートの基盤。\
- 非対象: GUI 具体実装フレームワーク差異、最適化(低レベルSIMD)、運用ツール群。

---
## 2. アーキテクチャ概要
### 2.1 レイヤ構成
| レイヤ | 役割 | 主依存 | 備考 |
|--------|------|--------|------|
| Presentation (GUI) | 状態可視化/操作入力 | Aggregator API | PySide6 等想定 (最終選定 OI) |
| Orchestration | プロセス生成/停止/監視 | Config / IPC | 単一メインプロセス |
| Capture & Inference Workers | 映像取得と推論 | OpenVINO Runtime / RTSPライブラリ | multiprocessing 各プロセス |
| Aggregation | 結果集約/バッファ/エクスポート | 内部データ構造 | スレッドセーフ or マルチプロセスIPC |
| Recording | 映像書き出し | FFmpegラッパ | オプション 動的開始/停止 |
| Tools (Offline) | モデル変換 | PyTorch / OpenVINO | 実行時ネットワーク不要 |
| Configuration | 設定ロード/検証 | XML Parser | 変換→内部辞書/Typed構造 |

### 2.2 データフロー (リアルタイム)
```
RTSP Stream -> (統合)CaptureInferenceWorker -> (Queue ResultRecord/StatsMessage)
  -> Orchestrator(ResultDispatcherThread) -> Aggregator(Buffer) -> GUI Renderer / Export / Recorder
  (将来案: CaptureWorker -> (Queue Frame) -> InferenceWorker 分離。現行MVPは統合型のみ実装)
```
遅延抑制: InferenceWorker はキュー最新フレームを優先 (古いもの破棄)。

### 2.3 プロセス/IPC モデル
( v0.6 追記: use_process=True の場合 )
- 子プロセス: 各カメラ1 `Process(target=run_capture_inference_worker_process)` が統合 Capture+Inference ループを実行。
- 親→子: `control_queue` は `multiprocessing.Queue` に置換 (PING 要求のみ送信; STOP まだ未実装)。
- 子→親: `result_queue` (ResultRecord / StatsMessage / StatusUpdate)。終了時は最終 StatsMessage (ExitNotice 未実装)。
- 停止: 親側 `self._proc_stop_event.set()` により子ループ break (暫定)。今後 ControlMessage(STOP) ブロードキャストへ移行予定。

( thread モードとの差分 )
| 項目 | thread | process |
|------|--------|---------|
| worker 実行 | 同一プロセス Thread | 別プロセス Process | 
| control_queue 型 | queue.Queue | multiprocessing.Queue |
| 停止シグナル | Event + スレッド join | MpEvent + join | 
| ログ転送 | (未実装: 同一プロセス) | (未実装: 将来 QueueHandler) |
| ExitNotice | 未 | 未 |

### 2.4 IPC メッセージ種別 (概要)
| 種別 | 方向 | フィールド例 | 用途 |
|------|------|--------------|------|
| ControlMessage | 親→子 | type: START/STOP/RELOAD/PING | 制御 (PING でヘルス確認要求) |
| Pong (impl) | 子→親 | ping_response=id | StatusUpdate.ping_response で擬似PONG 応答 |
| DownStatus (impl) | 子→親 | status=DOWN,last_error=ping_timeout | ping_loss_threshold 到達で Orchestrator が生成 (v0.5) |
| StatusUpdate | 子→親 | camera_id, status(RUNNING/RETRYING/DOWN), attempts, last_error? | 状態監視/GUI反映 |
| StatsMessage | 子→親 | camera_id, fps, avg_latency_ms, drop_rate | 統計融合 (1秒窓) ※p50/p95/EMA は Aggregator 側計算 |
| ExitNotice | 子→親 | code, reason | 異常/正常終了判定 (ControlMessage に EXITING は使用しない) |

Control/Status は軽量 `pickle` (標準) で十分。将来高速化時に `msgpack` など検討。

### 2.5 ロギング & メトリクス アーキテクチャ
v0.6 ステータス: プロセスモードでは集中ロギングは未着手。将来 `log_queue` と QueueListener を導入予定。現状は thread モード同等のシンプル構成。

| 要素 | 役割 | 技術 |
|------|------|------|
| log_queue | 全子プロセス LogRecord 集約 | `multiprocessing.Queue` |
| QueueHandler | 子プロセスロガー -> log_queue | `logging.handlers.QueueHandler` |
| LogListenerThread | メインで queue 消費 -> RotatingFile + Console 出力 | `QueueListener` |
| metrics thread | Aggregator 統計 (fps/ema_fps/avg/p50/p95/drop) を 1s 周期で収集/差分ログ | `threading.Thread` |

構成理由: (1) 子プロセスからファイル/コンソール競合を回避 (2) 一元フォーマット (3) JSON Lines (構造化) で後処理容易化。フォーマット例: `{ "ts":"...UTC...", "level":"INFO", "event":"STARTUP_COMPLETE", "camera":"cam01", "msg":"...", "latency_ms":12.3 }`。

ログレベル制御: 親のみが環境構築時に `root` を設定し子起動前に `LOG_LEVEL` を pipe 経由通知、子側は numeric level のみ使用 (文字列パース不要)。

---
## 3. コンポーネント責務定義
| 名称 | 主責務 | 入力 | 出力 | 例外方針 (概要) |
|------|--------|------|------|----------------|
| ConfigLoader | XML解析/検証/内部構造化 | XML Path | Config | 不正値→ValidationError 即停止 |
| Orchestrator | プロセスライフサイクル/監視/集中ログ初期化/結果ディスパッチ | Config/Commands | プロセス状態イベント | 子異常→再起動(閾値)/停止判定 |
| CaptureInferenceWorker | キャプチャ+前処理+推論+統計 | RTSP, Model | ResultRecord/StatsMessage/StatusUpdate | 接続断→再試行, モデル致命→Fatal |
| Aggregator | 結果集約/リングバッファ/統計融合/クエリ | ResultRecord/StatsMessage | ExportData/ViewModel | バッファ溢れ→古い順破棄 WARN (p50/p95, EMA FPS 提供) |
| Recorder | 映像保存+メタ出力 | フレーム | MP4+JSON | 書込失敗→ERROR 継続判定 |
| GUIAdapter | Aggregator 内部状態→GUI用変換 | AggregatedState | RenderState | 遅延測定 |
| LogListenerThread | ログ集中出力 | LogRecord | ファイル/STDERR | I/O エラー→Fallback Console |
| MetricsThread | 定周期集計/Publish/異常検知 | Aggregator | Log(METRIC),警告 | 計測失敗→WARN |
| ModelConverter (tool) | PyTorch→IR 変換 | 原モデル | IR + metadata | 失敗→Exit code !=0 |
| Messages (module) | IPC メッセージ dataclass 定義 | - | Typed Messages | - |

---
## 4. 主要インタフェース案 (シグネチャ草案)
(詳細設計で最終化。戻り値/例外は Google Docstring 想定)
```text
ConfigLoader.load(path: Path) -> Config
Orchestrator.start() -> None
Orchestrator.stop(timeout_s: float = 5.0) -> None
Orchestrator.spawn_worker(camera_id: str) -> None
Orchestrator.broadcast(msg: ControlMessage) -> bool  # 送信成功可否 (Pipe 断検知)
init_worker_process(camera_cfg: CameraConfig, control_conn, result_queue, log_queue, config: Config) -> None  # bootstrap 関数
Aggregator.push(result: ResultRecord) -> None
Aggregator.query(camera_id: str, since: datetime | None) -> List[ResultRecord]
Aggregator.export(fmt: str, range: TimeRange, dest: Path) -> Path
Recorder.start(camera_id: str) -> None
Recorder.stop(camera_id: str) -> Path
build_dashboard_state() -> DashboardState  # 統一名称 (旧: build_status_view)
serialize_log(record: LogRecord) -> str  # JSON Lines
```

---
## 5. データ構造(概要レベル)
| 構造 | フィールド (要件.md 由来) | 備考 |
|------|----------------------------|------|
| ResultRecord | camera_id / timestamp_utc / gesture_label / confidence / latency_ms? | latency_ms は計測可能な場合のみ |
| Config | cameras / model.* / inference.* / retry.* / buffer.* / recording.* / export.* / gui.* / logging.* | XML→内部マッピング |
| RingBuffer | capacity:int / data:deque | Lock or process-safe wrapper |
| ControlMessage | type / payload(dict) | START/STOP/RELOAD/PING |
| StatusUpdate | camera_id / status / attempts / last_error? | GUI 表示用 |
| StatsMessage | camera_id / fps / avg_latency_ms / drop_rate | 集計融合 (1秒窓) |
| ExitNotice | camera_id / code / reason | 終了通知統一 |

### 5.1 ExitNotice code値定義
| code | 説明 | 対応 |
|------|------|------|
| 0 | 正常終了 (STOP指示受信) | ログのみ |
| 10 | MODEL_LOAD_ERROR (モデルロード失敗) | 再起動しない、該当Worker停止 |
| 20 | STREAM_FATAL (カメラ接続不可能) | 再起動試行→上限で停止 |
| 30 | IPC_ERROR (パイプ通信異常) | 再起動試行 |
| 99 | UNEXPECTED_ERROR (その他例外) | 再起動試行 |

---
## 6. エラーハンドリング戦略 (高位)
| レベル | 方針 |
|--------|------|
| 取得系 | 再試行(指数バックオフ)。上限超過→Orchestratorへ異常通知 |
| 推論 | 単フレーム失敗→スキップ継続 (ERROR ログ)。初期ロード失敗→起動中断 |
| 設定 | 起動前検証で Fail Fast |
| 書込 | 一時失敗→再試行1回; 継続失敗→ユーザ通知 & 録画停止 |
| IPC | Pipe断検知→Orchestrator が子再起動 or graceful shutdown |
| ログ | LogListenerThread でファイル書込失敗時は STDERR フォールバック + once 警告 |

---
## 7. 性能/リソース方針
// 旧記述 (queue maxlen=1~2) は初期最適化による混乱を避け削除。
- メモリ: 各ワーカーでモデル常駐、共有メモリ最小化 (再ロードコスト < メモリ節約検討余地)
- 計測: Aggregator が per-camera stats (fps, ema_fps, avg latency, latency p50/p95, drop_rate) を定期集計。
- バックプレッシャ (統一アルゴリズム): `put_nowait` が Full → 最古1件を `get_nowait` で削除 → 1回のみ再 `put`。再失敗時は WARNING (RESULT_DROP_OVERFLOW)。破棄件数は drop counter として StatsMessage に含める。
- ターゲット遅延: エンドツーエンド (capture→GUI) p95 <= 500ms (暫定)。
- 再起動閾値: `max_restarts_per_camera=3` within `restart_window_sec=300` 超過で status=DOWN 固定。
- ヘルス監視: ping_interval=5s, ping_timeout=10s, 連続 ping_loss=3 で CAMERA_DOWN ログ + StatusUpdate(status=DOWN) (v0.5 時点)。回復時 CAMERA_RECOVER ログ。

---
## 8. ログ/監視コンセプト
| 種別 | 例 event_code | 目的 |
|------|---------------|------|
| INFO | STARTUP_COMPLETE | 起動完了観測 |
| WARNING | CAPTURE_RETRY | 再接続回数監視 |
| WARNING | RESULT_DROP_OVERFLOW | キュー満杯でのドロップ監視 |
| ERROR | INFER_FAIL | 推論失敗率監視 |
| CRITICAL | MODEL_LOAD_ERROR | 即時停止判断 |
| METRIC(DEBUG) | PERF_LATENCY | 性能チューニング |

クラッシュログは `app/logs/crash_<timestamp>.log`。

集中ロギング追加仕様:
```
子プロセス logger -> QueueHandler(log_queue) -> 親 QueueListener -> JSONFormatter -> RotatingFileHandler(logs/app.log, 10MB x 5) + RichConsole(optional)
```
構造化キー: ts / level / event / camera / pid / process_name / msg / exc / latency_ms / fps / ema_fps / latency_p50_ms / latency_p95_ms / drop_rate。

ヘルス監視: metrics thread が各 camera の最後の結果受信からの経過時間 > (3/target_fps + 1s) で WARNING (event=CAMERA_STALL)。ping_loss 監視は別途 Orchestrator 側で実施。
セキュリティ: IPC シリアライズに pickle (初期) を使用するため外部/不正ソースからのデータを受け取らない信頼境界を明確化。将来 msgpack へ移行し安全性/性能向上 (署名検討)。
timestamp: `ResultRecord.timestamp_utc` は ISO8601 UTC (`YYYY-MM-DDTHH:MM:SS.sssZ`)。内部計測 (FPS/latency) は `time.monotonic()` を使用しクロック差異の影響を除去。

---
## 9. 設定ファイル設計 (アウトライン)
XML 要素 → 内部キー (例)  (v0.3 追加: restart/ping/logging/perf 閾値設定)
```xml
<ApplicationConfig>
  <Cameras>
    <Camera id="cam01" url="rtsp://..."/>
  </Cameras>
  <Model xml="models/gesture.xml" bin="models/gesture.bin" metadata="models/gesture.meta.json" />
  <Inference target_fps="10" device="AUTO" />
  <Retry connect_max_attempts="5" connect_backoff_sec="1.0" />
  <Buffer results_max_entries="10000" />
  <Recording enabled="true" output_dir="results/recordings" />
  <Export default_format="csv" />
  <Restart max_restarts_per_camera="3" restart_window_sec="300" />
  <Health ping_interval_sec="5" ping_timeout_sec="10" ping_loss_threshold="3" />
  <Perf latency_p95_target_ms="500" drop_rate_warn="0.05" />
  <GUI theme="dark" />
  <Logging dir="app/logs" level="INFO" />
</ApplicationConfig>
```

---
## 10. テスト方針マッピング (概要)
| 要件ID | テストタイプ | 代表ケース |
|--------|--------------|------------|
| FR-01/02 | Integration | カメラ数=1/2 で起動成功 |
| FR-11 | Performance | 10fps 目標下で平均レイテンシ計測 |
| FR-50 | Unit+Integration | リングバッファ容量超過挙動 |
| FR-90 | Fault Injection | 強制例外→クラッシュログ生成 |
| NFR-02 | Load | 4カメラ並列 FPS 実測 |
| NFR-Logging | Unit | 子プロセスログが JSON 形式で欠損なく集約 |
| NFR-Stability | Integration | result_queue 飽和時の drop_rate 計測 & 警告出力 |
| NFR-Shutdown | Integration | STOP ブロードキャスト後 < timeout 内全子終了 |
| NFR-Restart | Integration | 再起動回数上限・window 超過時 DOWN 固定 |
| NFR-Ping | Integration | ping_loss_threshold 超過で DOWN 遷移 |

---
## 11. 移植性/外部依存
- OpenVINO / PyTorch (変換時のみ)。\
- RTSPライブラリ候補: opencv(VideoCapture) 先行利用 → 性能課題時 GStreamer 再検討。

---
## 12. セキュリティ/閉域考慮
- 外部HTTP禁止: モデル/依存は事前配置のみ。\
- ログに資格情報なし (現時点で扱わない)。

---
## 13. オープン事項 (基本設計段階)
| ID | 内容 | 対応予定 |
|----|------|----------|
| OI-01 | ジェスチャークラス集合 | 詳細設計でラベルファイル仕様定義 |
| OI-02 | 最大カメラ台数 | 性能検証タスクで上限測定 |
| OI-03 | GUI フレームワーク | PoC 比較後決定 |
| OI-04 | 動的設定リロード (RELOAD メッセージ) | 後続要否評価 |
| OI-05 | メトリクス OpenTelemetry 連携 | 非機能要求評価後 |
| OI-06 | pickle→msgpack 移行 | セキュリティ/性能評価後 |
| OI-07 | (解消) STOP ControlMessage / ExitNotice 実装 | v0.6 で実装済 |

---
## 14. Copilot への提示用ミニ要約 (貼付テンプレ)
```
【Context】複数RTSP→OpenVINO推論→GUI表示システム。基本設計に従い詳細化/実装を行う。
【Modules】ConfigLoader / Orchestrator / Worker / Aggregator / Recorder / GUIAdapter / Messages / Logging (QueueHandler)
【Key Constraints】No env vars, pathlib, ≥90% tests, latency & reconnection & logging queue covered.
【Interfaces(草案)】ConfigLoader.load, Orchestrator.start/stop/broadcast, init_worker_process, Aggregator.push/query/export, ResultDispatcherThread ...
【Error Policy】取得再試行, 推論単フレーム失敗=継続, 設定/モデル致命=即停止, IPC断=再起動 or shutdown, ping_timeout=DOWN
【Output Expectation】1) 詳細設計補完 2) 実装コード 3) テスト 4) 改善提案
```

---
## 15. 変更管理
- 本書更新は PR にて (label: basic-design)。 v0.6: マルチプロセス試験モード追加, 既知未実装(OI-07)。
