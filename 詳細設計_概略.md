# 詳細設計_概略.md

バージョン: 0.1 (2025-08-16)
目的: 初心者/新メンバー向けに詳細設計のポイントを平易に可視化。GitHub Copilot 用の圧縮表現とは別に読みやすさを重視。

---
## 1. コンポーネント相関図
```mermaid
flowchart TB
  subgraph Main[メインプロセス]
    ORC[Orchestrator]<-->|control|WPIPE[Control Pipes]
    DISP[ResultDispatcher<br/>Thread]
    AGG[Aggregator<br/>結果集約]
    LOG[LogListener<br/>集中ログ]
    MET[MetricsThread<br/>統計]
  end
  subgraph Workers[各 Worker プロセス]
    W1[Worker cam01]
    W2[Worker cam02]
  end
  W1 -->|ResultRecord / StatsMessage / ExitNotice| DISP
  W2 -->|ResultRecord / StatsMessage / ExitNotice| DISP
  DISP --> AGG
  AGG -->|ViewState| GUI[GUI]
  ORC --> LOG
  ORC --> MET
```

---
## 2. プロセスとキュー/パイプ
| 名称 | 種別 | 役割 | 重要ポイント |
|------|------|------|--------------|
| result_queue | multiprocessing.Queue | 推論結果/統計受け渡し | 満杯時 古い結果ドロップ |
| control_pipe | Pipe (親⇄各子) | 制御・状態 | STOP/PING/StatusUpdate |
| log_queue | multiprocessing.Queue | ログ集中 | QueueHandler 利用 |

---
## 3. メッセージ概要
| 型 | 主フィールド | 送信元→先 | 目的 |
|----|--------------|-----------|------|
| ControlMessage | type,payload | 親→子 | STOP/PING 等 |
| StatusUpdate | camera_id,status | 子→親 | 状態表示/再起動判断 |
| StatsMessage | camera_id,fps,avg_latency_ms | 子→親 | 統計融合/監視 |
| ExitNotice | camera_id,code,reason | 子→親 | 終了検知 |

---
## 4. Worker のループ (簡略図)
```mermaid
flowchart LR
  A[開始 INIT] --> B[モデルロード]
  B -->|成功| C{STOP指示?}
  C -->|Yes| Z[ExitNotice]
  C -->|No| D[フレーム取得]
  D -->|失敗 再試行| C
  D --> E[前処理+推論]
  E --> F[結果を result_queue]
  F --> G{1秒経過?}
  G -->|Yes| H[StatsMessage 送信] --> C
  G -->|No| C
```

---
## 5. Aggregator の役割
- カメラごとのリングバッファ (最新優先) 保持
- 統計 (fps, 平均レイテンシ, 最終更新時刻, ドロップ率) を保持
- GUI / Export へクエリ API を提供

補足: push() は ResultRecord / StatsMessage / ExitNotice を受理し、ExitNotice 到達で該当カメラをクローズ状態にマーク。

---
## 6. ログパイプライン
```mermaid
sequenceDiagram
  participant W as Worker
  participant LQ as log_queue
  participant LL as LogListener
  participant F as File(Console)
  W->>LQ: LogRecord(JSON化前)
  LL->>LQ: get()
  LL->>F: JSON Lines 出力
```

---
## 7. 主要インタフェース (意図レベル)
| 名前 | 入力 | 出力 | 概要 |
|------|------|------|------|
| ConfigLoader.load | path | Config | 設定 XML → 構造体 |
| Orchestrator.start | - | - | 各種初期化+Worker起動 |
| Orchestrator.stop | timeout | - | 停止指示→終了監視 |
| Aggregator.push | record/message | - | 結果/統計を内部保存 |
| Aggregator.query | camera_id,since | list | 条件取得 |
| Aggregator.export | fmt,range,dest | Path | ファイル出力 (csv/jsonl) |
| Recorder.start/stop | camera_id | Path? | 録画制御 |
| build_dashboard_state | - | dict/DTO | GUI 表示用 (label, confidence, fps, status, drop_rate) |

Export 補足: time range 指定 (期間フィルタ) と csv / jsonl 形式に対応 (列セット固定)。

---
## 8. エラーと対応
| 例 | 発生場所 | 対応 | ログ event |
|----|----------|------|-----------|
| モデルロード失敗 | Worker 起動時 | 即 ExitNotice(code≠0) | MODEL_LOAD_ERROR |
| カメラ切断 | Worker ループ | 再試行→上限で DOWN | CAPTURE_RETRY / CAMERA_DOWN |
| 結果キュー満杯 | Worker put | 古い結果1件捨てる | RESULT_DROP |
| 長時間更新なし | MetricsThread | WARNING ログ | CAMERA_STALL |

例外分類 (Fatal=即停止): ConfigValidationError, ModelLoadError / Non-Fatal: InferenceError, StreamConnectionError(再試行), IPCChannelError(再起動判定)。

---
## 9. パフォーマンス指標
| 指標 | 目標 | 取得方法 |
|------|------|----------|
| FPS | 設定 target ± 許容 | StatsMessage fps |
| 推論レイテンシ p95 | < 500ms (暫定) | latency_ms 集計 |
| ドロップ率 | 低 (<5%) | drop_count / (produced+drop) |

追加閾値初期値: 再起動=3回/300s, ping=5s間隔/timeout10s/3連続失敗, stall条件=last_result_age > 3/target_fps +1s。

---
## 10. テスト観点まとめ
| 観点 | 例 | 目的 |
|------|----|------|
| RingBuffer容量 | 超過時先頭消去 | メモリ制御 |
| 2カメラ並列 | 結果が双方来る | IPC 正常性 |
| キュー飽和 | 小容量設定 | ドロップ動作検証 |
| Fault Injection | モデルロード例外 | 異常終了ログ確認 |
| Shutdown | STOP ブロードキャスト | すべての ExitNotice 確認 |
| Restart Policy | 異常再起動試験 | 300s内4回目で DOWN |
| Health Ping | 意図的応答停止 | 3連続 timeout で DOWN |

---
## 11. 将来の改善メモ
- msgpack 化で IPC 軽量化
- Worker 分離 (Capture / Infer)
- 遅延しきい値超過フレームの画像ダンプ (デバッグ)
- OpenTelemetry でメトリクス配信

---
## 12. 用語簡易集
| 用語 | 説明 |
|------|------|
| StatsMessage | 1秒ごとの統計情報メッセージ |
| ExitNotice | プロセス終了時の通知メッセージ |
| Drop | キュー満杯で捨てた結果 |
| monotonic | 誤差/時間逆行影響を受けない内部計測クロック |

---
## 13. 信頼性と監視 (初心者向け要点)
細かい数値は詳細設計本編を参照。ここでは仕組みのイメージだけ。
- 結果が詰まったら: 一番古い物を捨てて最新を優先
- 何度も落ちる Worker: 「もう安定しない」と判断し停止
- 返事の無いカメラ: 何回か無応答なら DOWN 扱い
- 長く更新なし: Stall として警告
- 時刻扱い: 表示用と内部計測用で別の時計を使い精度確保

## 14. Shutdown の流れ (ざっくり)
STOP 合図 → 各 Worker 終了通知 → 残りの結果処理 → 監視/ログスレッドを順番に閉じる。

## 15. MetricsThread の役割 (短縮)
"止まっていないか" と "遅くなっていないか" を見張り、必要なときだけ警告ログを出す。

## 16. Recorder のメモ
録画ファイルと一緒に開始/終了時刻などの簡単なメタ情報を残す予定。

---
(以上)
